{% extends "templates/base.html" %}

{% block content %}

    <ol class="breadcrumb mb-2">
        <li class="breadcrumb-item"><a href="/tutores">Tutores</a></li>
        <li class="breadcrumb-item active">{{parametros.title}}</li>
    </ol>
    
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary" id="manutencaoTitulo">Cadastrar Novo Tutor</h6>
        </div>
        <div class="card-body">
            
            <form id="formManutencaoTutor">
                <input type="hidden" id="tutorid" name="tutorid" value="0">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nome" class="form-label">Nome Completo*</label>
                        <input type="text" class="form-control" id="nome" name="nome" required>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="cpf" class="form-label">CPF*</label>
                        <input type="text" class="form-control" id="cpf" name="cpf" required>
                    </div>

                    <div class="col-md-3 mb-3">
                        <label for="telefone" class="form-label">Telefone</label>
                        <input type="text" class="form-control" id="telefone" name="telefone">
                    </div>
                </div>

                <hr>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="rua" class="form-label">Rua</label>
                        <input type="text" class="form-control" id="rua" name="rua">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="numero" class="form-label">Número</label>
                        <input type="text" class="form-control" id="numero" name="numero">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="bairro" name="bairro">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" class="form-control" id="cidade" name="cidade">
                    </div>
                </div>

                <div class="mt-4">
                    <button type="button" class="btn btn-primary me-2" onclick="salvarTutor()">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/tutores'">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <p id="mensagemErro" class="text-danger mt-3"></p>
                </div>
            </form>
        </div>
    </div>

<script src="/static/js/api.js"></script>
<script>
    
    const formManutencao = document.getElementById('formManutencaoTutor');
    const params = new URLSearchParams(window.location.search);
    const tutorId = params.get('tutorid') || 0;
    const isEdicao = tutorId !== 0;

    window.onload = function () {
        if (isEdicao) {
            document.getElementById('manutencaoTitulo').textContent = `Editar Tutor (ID: ${tutorId})`;
            carregarDadosTutor(tutorId);
        } else {
            document.getElementById('tutorid').value = 0;
            document.getElementById('manutencaoTitulo').textContent = 'Cadastrar Novo Tutor';
        }
    };

    /**
     * Função para carregar os dados de um tutor existente (apenas em modo Edição).
     * @param {number} id - O ID do tutor.
     */
    async function carregarDadosTutor(id) {
        document.getElementById('tutorid').value = id;
        document.getElementById('mensagemErro').textContent = 'Carregando dados...';

        const response = await fetchAPI('/getTutoresByID', {
            method: 'POST',
            body: JSON.stringify({ tutorid: id })
        });
        
        document.getElementById('mensagemErro').textContent = '';

        if (response.status === 'ok' && response.registro && response.registro.length > 0) {
            const tutor = response.registro[0];
            document.getElementById('nome').value = tutor.nome;
            document.getElementById('cpf').value = tutor.cpf;
            document.getElementById('telefone').value = tutor.telefone;
            document.getElementById('rua').value = tutor.rua;
            document.getElementById('numero').value = tutor.numero;
            document.getElementById('bairro').value = tutor.bairro;
            document.getElementById('cidade').value = tutor.cidade;
        } else {
            document.getElementById('mensagemErro').textContent = 'Erro ao carregar os dados do tutor.';
            alert('Erro: Tutor não encontrado ou falha na API.');
        }
    }

    /**
     * Salva (Insere ou Atualiza) os dados do formulário.
     */
    async function salvarTutor() {
        // Validação simples (campos obrigatórios)
        if (!document.getElementById('nome').value || !document.getElementById('cpf').value) {
            document.getElementById('mensagemErro').textContent = 'Erro: Nome e CPF são obrigatórios.';
            return;
        }

        const id = document.getElementById('tutorid').value;
        const isUpdate = id !== '0';
        
        const formData = new FormData(formManutencao);
        const tutorData = Object.fromEntries(formData.entries());

        const endpoint = isUpdate ? '/updateTutores' : '/insertTutores';
        
        document.getElementById('mensagemErro').textContent = 'Salvando...';

        const response = await fetchAPI(endpoint, {
            method: 'POST',
            body: JSON.stringify(tutorData)
        });

        document.getElementById('mensagemErro').textContent = '';

        if (response.status === 'ok') {
            alert(isUpdate ? 'Tutor atualizado com sucesso!' : 'Tutor cadastrado com sucesso!');
            // Volta para a tela de listagem
            window.location.href = '/tutores'; 
        } else {
            document.getElementById('mensagemErro').textContent = 'Falha ao salvar. Erro: ' + (response.message || response.status);
            alert('Falha ao salvar. Verifique o console.');
        }
    }

</script>

{% endblock %}